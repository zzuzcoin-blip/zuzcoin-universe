const express = require('express');
const Web3 = require('web3');
const cors = require('cors');
require('dotenv').config();

// Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ RPC Ğ´Ğ»Ñ Polygon Mumbai
const web3 = new Web3('https://polygon-mumbai.g.alchemy.com/v2/demo');
console.log('âœ… Using public Polygon Mumbai RPC');

const app = express();
app.use(cors());
app.use(express.json());

// Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚
app.get('/', (req, res) => {
  res.json({ 
    status: 'online',
    network: 'Polygon Mumbai',
    message: 'ZUZCOIN Universe - Real Blockchain'
  });
});

// ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğº Ğ±Ğ»Ğ¾ĞºÑ‡ĞµĞ¹Ğ½Ñƒ
app.get('/api/blockchain/status', async (req, res) => {
  try {
    const blockNumber = await web3.eth.getBlockNumber();
    const accounts = await web3.eth.getAccounts();
    
    res.json({
      connected: true,
      network: 'Polygon Mumbai',
      chainId: 80001,
      blockNumber: blockNumber,
      accounts: accounts,
      rpcUrl: 'https://polygon-mumbai.g.alchemy.com/v2/demo'
    });
  } catch (error) {
    res.status(500).json({
      connected: false,
      error: error.message
    });
  }
});

// ĞŸÑ€Ğ¾ÑÑ‚Ğ°Ñ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ (Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ°)
app.post('/api/register', async (req, res) => {
  try {
    const { work } = req.body;
    
    // Ğ¡Ğ¸Ğ¼ÑƒĞ»ÑÑ†Ğ¸Ñ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸
    const txHash = '0x' + Math.random().toString(16).substr(2, 64);
    
    res.json({
      success: true,
      message: 'Copyright Registered on Polygon Mumbai!',
      work: work,
      transaction: txHash,
      network: 'Polygon Mumbai',
      explorer: `https://mumbai.polygonscan.com/tx/${txHash}`
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// Ğ—Ğ°Ğ¿ÑƒÑĞº ÑĞµÑ€Ğ²ĞµÑ€Ğ°
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`ğŸš€ Server running on port ${PORT}`);
  console.log(`ğŸŒ Network: Polygon Mumbai`);
  console.log(`ğŸ”— RPC: https://polygon-mumbai.g.alchemy.com/v2/demo`);
});
